# JVM调优工具

## 1.jps：虚拟机进程状态工具

**作用：**可以列出正在运行的虚拟机进程，并显示虚拟机执行主类（main函数所在的类）名称以及这些进程的本地虚拟机唯一ID。

**命令格式：jps [options] [hostid]**

**参数说明：**

| 选项 | 作用                                                 |
| ---- | ---------------------------------------------------- |
| -q   | 只输出LVMID（进程ID），省略主类的名称                |
| -m   | 输出虚拟机进程启动时传递给主类main()函数的参数       |
| -l   | 输出主类的全名，如果进程执行的是JAR包，则输出JAR路径 |
| -v   | 输出虚拟机进程启动时的JVM参数                        |

**执行样例：**

![image-20220216165014462](https://gitee.com/gudayu/gzy-img/raw/master/img/image-20220216165014462.png)



## 2.jstat：虚拟机统计信息监视工具

**作用：**用于监视虚拟机各种运行状态信息的命令行工具。他可以显示本地或远程虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据，在没有GUI图形界面、只提供纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的常用工具。

**命令格式：**jstat [ option vmid [interval [s|ms] [count]] ]  

**说明：**如果本是本地虚拟机进程，VMID与LVMID是一致的。

**参数说明：**

| 选项              | 作用                                                         |
| ----------------- | ------------------------------------------------------------ |
| -class            | 监视类加载、卸载数量、总空间以及类装载所耗费的时间           |
| -gc               | 监视java堆状态，包括Eden、survivor、老年代、永久代等的容量，已用空间，垃圾收集时间合计等信息 |
| -gccapacity       | 监视内容与-gc基本相同，但是输出主要关注java堆各个区域使用到的最大最小空间 |
| -gcutil           | 监视内容与-gc基本相同，单输出主要关注已使用空间占总空间的百分比 |
| -gccause          | 与上功能一样，但会额外输出导致上次垃圾收集的原因             |
| -gcnew            | 监视新生代垃圾收集状态                                       |
| -gcnewcapacity    | 监视与上基本相同，输出主要关注使用到的最大、最小空间         |
| -gcold            | 监视老年代垃圾收集状况                                       |
| -gcoldcapacity    | 与上相同，输出主要关注使用到的最大、最小空间                 |
| -gcpermcapacity   | 输出永久代使用到的最大、最小空间                             |
| -compiler         | 输出即时编译器编译过的方法、耗时等信息                       |
| -printcompilation | 输出已经被即时编译的方法                                     |

**执行样例：**

**常用命令：jstat -gc 1 1000 5**

上述命令的含义，对ID为1进程的堆状态进行监视，每隔1000ms输出一次，总共输出5次，输出信息包括Eden、survivor、老年代、永久代等容量及GC的信息

![image-20220216175526990](https://gitee.com/gudayu/gzy-img/raw/master/img/image-20220216175526990.png)

查询结果说明：

- S0C survivor0大小
- S1C survivor1大小
- S0U survivor0已使用大小
- S1U survivor1已使用大小
- EC Eden区大小
- EU Eden区已使用大小
- OC 老年代大小
- OU 老年代已使用大小
- MC 方法区大小
- MU 方法区已使用大小
- CCSC 压缩类空间大小
- CCSU 压缩类空间已使用大小
- YGC 年轻代垃圾回收次数
- YGCT 年轻代垃圾回收消耗时间
- FGC 老年代垃圾回收次数
- FGCT 老年代垃圾回收消耗时间
- GCT 垃圾回收消耗总时间

以上空间表示单位为字节

**执行命令：jstat -gcutil 1 1000 5**

![image-20220216182846541](https://gitee.com/gudayu/gzy-img/raw/master/img/image-20220216182846541.png)

查询结果说明：这台服务器的新生代Eden区（E，表示Eden）的刷新速度很快，5秒内增长将近20%，同时matespace占用率很高。

- S0：幸存1区当前使用比例
- S1：幸存2区当前使用比例
- E：伊甸园区使用比例
- O：老年代使用比例
- M：元数据区使用比例
- CCS：压缩使用比例
- YGC：年轻代垃圾回收次数
- FGC：老年代垃圾回收次数
- FGCT：老年代垃圾回收消耗时间
- GCT：垃圾回收消耗总时间

**执行命令：jstat -gccause 1**

![image-20220216181836878](https://gitee.com/gudayu/gzy-img/raw/master/img/image-20220216181836878.png)

查询结果说明：上次发生GC的原因是Allocation Failure

## 3.jmap:java内存映像工具

**作用：**用于生成堆转存储快照（一般称为heap dump或dump文件）。如果不使用jmap命令，要想获取java堆转存储快照也还有一下比较包里的手段，比如-XX:+HeapDumpOnOutOfMemoryError参数，可以让虚拟机在内存溢出异常出现之后自动生成堆转储快照文件，通过-XX:+HeapDumpOnCtrlBreak参数可以使用【Ctrl】+【Break】键让虚拟机生成堆转储快照文件。

jmap的作用并不仅仅是为了获取堆转储快照，它还可以查询finalize执行队列、Java堆和方法区的 详细信息，如空间使用率、当前用的是哪种收集器等。

**命令格式：jmap [option] vmid**

| 选项           | 作用                                                         |
| -------------- | ------------------------------------------------------------ |
| -dump          | 生成java堆转储快照                                           |
| -finalizerinfo | 显示在F-Queue中等待finalizer线程执行finalize方法的对象       |
| -heap          | 显示java堆详细信息，如使用哪种回收器、参数配置、分代状况等。 |
| -histo         | 显示堆中对象统计信息，包括类、实例数量、合计容量             |
| -permstat      | 以classloader为统计口径显示永久代内存状态                    |
| -F             | 当虚拟机进程对-dump选项没有响应时，可使用这个选项强制生成dump快照 |

**执行样例：**

**常用命令：jmap -heap 1**